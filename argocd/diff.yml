name: "argocd-diff"
description: "Builds the k8s config and creates a diff based on running state in argocd"

runs:
  using: "composite"
  steps:
    - id: argocd
      shell: /bin/bash
      run: |
        if [ "$GIT_REF" == "development" ]; then
          echo ::set-output name=server-url::argocd.euc1.t.get-protocol.dev
          echo ::set-output name=token::$EUC1TESTING_TOKEN
        elif [ "$GIT_REF" == "master" ]; then
          echo ::set-output name=server-url::argocd.euc1.s.get-protocol.dev
          echo ::set-output name=token::$EUC1STAGING_TOKEN
        elif [ "$GIT_REF" == "production" ]; then
          echo ::set-output name=server-url::argocd.euc1.get-protocol.cloud
          echo ::set-output name=token::$EUC1_TOKEN
        fi
      env:
        GIT_REF: ${{ github.base_ref }}
        EUC1TESTING_TOKEN: ${{ secrets.ARGOCD_EUC1TESTING_API_AUTH }}
        EUC1STAGING_TOKEN: ${{ secrets.ARGOCD_EUC1STAGING_API_AUTH }}
        EUC1_TOKEN: ${{ secrets.ARGOCD_EUC1_API_AUTH }}

    - uses: imranismail/setup-kustomize@v1

    - uses: GETProtocolLab/argocd-diff-action@master
      name: ArgoCD Diff testing
      with:
        argocd-server-url: ${{ steps.argocd.outputs.server-url }}
        argocd-token: ${{ steps.argocd.outputs.token }}
        argocd-version: v2.1.6
        argocd-extra-cli-args: --grpc-web
        argocd-lovely-plugin-token: ${{ secrets.GH_PACKAGES_ACCESS }}
        github-token: ${{ secrets.GITHUB_TOKEN }}