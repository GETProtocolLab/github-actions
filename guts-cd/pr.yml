name: "guts-cd"
description: "This action combines argocd-deploy, argocd-diff and argocd-build and should be called on both push and pr actions"
inputs:
  # Argocd general
  argocd_server:
    description: "the url of the argocd server to use"
    required: true
  argocd_euc1_testing_token:
    description: "The token to authenticate to argocd server"
    required: true
  argocd_euc1_staging_token:
    description: "The token to authenticate to argocd server"
    required: true
  argocd_euc1_token:
    description: "The token to authenticate to argocd server"
    required: true
  # Argocd diff
  argocd_lovely_plugin_token:
    description: "Token to use that authenticates the argocd loverly plugin? todo: ask @mihai"
    required: true
  github_token:
    description: "Token to use to authenticate to github for commenting on the pr"

runs:
  using: "composite"
  steps:
    - id: argocd
      shell: bash
      if: github.base_ref  == 'development' || github.base_ref  == 'master' || github.base_ref  == 'production'
      run: |
        if [ "$GIT_REF" == "development" ]; then
          echo ::set-output name=server-url::argocd.euc1.t.get-protocol.dev
          echo ::set-output name=token::$EUC1TESTING_TOKEN
          echo ::set-output name=overlay::deploy/overlays/euc1-testing
        elif [ "$GIT_REF" == "master" ]; then
          echo ::set-output name=server-url::argocd.euc1.s.get-protocol.dev
          echo ::set-output name=token::$EUC1STAGING_TOKEN
          echo ::set-output name=overlay::deploy/overlays/euc1-staging
        elif [ "$GIT_REF" == "production" ]; then
          echo ::set-output name=server-url::argocd.euc1.get-protocol.cloud
          echo ::set-output name=token::$EUC1_TOKEN
          echo ::set-output name=overlay::deploy/overlays/euc1
        fi
      env:
        GIT_REF: ${{ github.base_ref }}
        EUC1TESTING_TOKEN: ${{ inputs.argocd_euc1_testing_token }}
        EUC1STAGING_TOKEN: ${{ inputs.argocd_euc1_staging_token  }}
        EUC1_TOKEN: ${{ inputs.argocd_euc1_token  }}

    - uses: ../argocd-diff
      if: github.base_ref  == 'development' || github.base_ref  == 'master' || github.base_ref  == 'production'
      with:
        argocd_server: ${{ steps.argocd.outputs.server-url }}
        argocd_token: ${{ steps.argocd.outputs.token }}
        argocd_lovely_plugin_token: ${{ inputs.argocd_lovely_plugin_token }}
        github_token: ${{ inputs.github_token }}
